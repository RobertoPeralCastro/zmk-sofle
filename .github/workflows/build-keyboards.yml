name: Build Keyboards

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Cache west modules
      uses: actions/cache@v3
      with:
        path: |
          .west/
          modules/
          zephyr/
          bootloaders/
        key: ${{ runner.os }}-build-${{ env.cache_name }}-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake', '**/west.yml') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache_name }}-
          ${{ runner.os }}-build-
          
    - name: Initialize West
      run: |
        pip install west
        west init -l config
        
    - name: Update modules
      run: |
        west update
        
    - name: Setup Zephyr
      run: |
        pip install -r zephyr/scripts/requirements.txt
        
    - name: Parse build matrix
      run: |
        echo "build_matrix=$(yq eval -o json -I0 build.yaml)" >> $GITHUB_ENV
        
    - name: Build firmware
      run: |
        echo "${{ env.build_matrix }}" | jq -c '.include[]' | while read -r line; do
          board=$(echo "$line" | jq -r '.board')
          shield=$(echo "$line" | jq -r '.shield // empty')
          cmake_args=$(echo "$line" | jq -r '.["cmake-args"] // empty')
          artifact_name=$(echo "$line" | jq -r '.["artifact-name"] // empty')
          
          if [ -n "$shield" ]; then
            west build -b "$board" "$shield" -- "$cmake_args"
          else
            west build -b "$board" -- "$cmake_args"
          fi
          
          if [ -n "$artifact_name" ]; then
            find build/zephyr -name "*.uf2" -exec cp {} "${artifact_name}.uf2" \;
          else
            find build/zephyr -name "*.uf2" -exec cp {} "${board}_${shield}.uf2" \;
          fi
        done
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: firmware-files
        path: "*.uf2"
